document.addEventListener("DOMContentLoaded", function () {
    // ========================
    // 1. ELEMENTOS DEL DOM
    // ========================
    const chatbot = document.getElementById("chatbot");
    const launcher = document.getElementById("launcher");
    const minimizeBtn = document.getElementById("minimizeBtn");
    const closeBtn = document.getElementById("closeBtn");
    const chatbotHeader = document.getElementById("chatbotHeader");
    const chatMessages = document.getElementById("chatMessages");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const videoAvatar = document.getElementById("asistente-video");

    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImage");
    const closeModal = document.getElementById("closeModal");
    const openHdLink = document.getElementById("openHD");

    // ========================
    // 2. VARIABLES DE ESTADO
    // ========================
    let isMinimized = false;
    let isClosed = false;
    let currentMenu = "main";
    let menuHistory = [];
    let typingTimeout;

    // ========================
    // 3. FUNCIONES DE PERSISTENCIA
    // ========================
    function saveChatbotState() {
        const state = {
            isMinimized: isMinimized,
            isClosed: isClosed,
            currentMenu: currentMenu,
            menuHistory: menuHistory
        };
        localStorage.setItem("chatbotState", JSON.stringify(state));
    }

    function loadChatbotState() {
        const savedState = localStorage.getItem("chatbotState");
        if (savedState) {
            const state = JSON.parse(savedState);
            isMinimized = state.isMinimized;
            isClosed = state.isClosed || false;
            currentMenu = state.currentMenu || "main";
            menuHistory = state.menuHistory || [];

            // Aplicar estado visual al cargar
            if (isMinimized) {
                chatbot.classList.add("minimized");
                minimizeBtn.innerHTML = '<i class="fas fa-plus"></i>';
            }
            if (isClosed) {
                chatbot.classList.add("closed");
                launcher.style.display = "flex";
            } else {
                chatbot.classList.remove("closed");
                launcher.style.display = "none";
                chatbot.classList.add("visible");
            }
        } else{
            // Estado por defecto (sin datos en localStorage)
        launcher.style.display = "none";  // üëà Oculta el lanzador
        chatbot.classList.add("visible");  // üëà Muestra el chat
        }
    }

    // ========================
    // 4. FUNCIONES DEL CHATBOT
    // ========================
    function showTypingIndicator() {
        const typingDiv = document.createElement("div");
        typingDiv.className = "typing-indicator";
        typingDiv.innerHTML = "<span></span><span></span><span></span>";
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return typingDiv;
    }

    const menuStructure = {
        main: {
            title: "üåü ¬°Bienvenido a GERAGRI! üå±\nTu asistente agribot :D",
            options: [
                {
                    text: "<strong>üìÇ Servicio de Tr√°mites</strong>",
                    action: "menu",
                    target: "STRAMITES",
                },
                {
                    text: "<strong>‚öñÔ∏è Procedimientos Legales</strong>",
                    action: "menu",
                    target: "PLEGALES",
                },
                {
                    text: "<strong>üèûÔ∏è Procedimientos comunidades campesinas, nativas y eriazos</strong>",
                    action: "menu",
                    target: "PAREA",
                },
                {
                    text: "<strong>üî¥ Terminar chat</strong>",
                    action: "end",
                    response:
                        "üëã ¬°Gracias por usar en GERAGRIBOT! \nSi necesitas m√°s ayuda, aqu√≠ estar√©.",
                },
            ],
        },
        STRAMITES: {
            title:
                "üìã <strong>Tr√°mites Disponibles</strong>\nSelecciona una opci√≥n:",
            options: [
                {
                    text: "üèñÔ∏è Vacaciones Truncas y/o Compensaci√≥n vacacional",
                    action: "message",
                    response:
                        "üìú <strong>Requisitos:</strong>\n‚Ä¢ Solicitud dirigida al gerente.\n‚Ä¢ Contratos, adendas o resoluciones de designaci√≥n y conclusi√≥n.\n‚Ä¢ Constancia de no deudor de la Unidad no Estructurada de Contabilidad, Tesorer√≠a y Control Patrimonial.",
                },
                {
                    text: "‚è≥ Compensaci√≥n por Tiempo de Servicios",
                    action: "message",
                    response:
                        "üìú <strong>Requisitos:</strong>\n‚Ä¢ Solicitud dirigida al gerente.\n‚Ä¢ Resoluci√≥n de cese.\n‚Ä¢ Constancia de pagos y descuentos.\n‚Ä¢ Constancia de no deudor de la Unidad no Estructurada de Contabilidad, Tesorer√≠a y Control Patrimonial.",
                },
                {
                    text: "üíù Pensi√≥n por Sobrevivencia",
                    action: "message",
                    response:
                        "üìú <strong>Requisitos:</strong>\n‚Ä¢ Solicitud dirigida al gerente.\n‚Ä¢ Acta de defunci√≥n.\n‚Ä¢ Acta original de matrimonio.\n‚Ä¢ DNI del fallecido.\n‚Ä¢ DNI del solicitante.\n‚Ä¢ Formato III - <em>FORMATO DE SOLICITUD de la Resoluci√≥n Jefatural N¬∞ 150-2021-ONP-JF.</em>\n‚Ä¢ Resoluci√≥n de nombramiento.\n‚Ä¢ Resoluci√≥n de incorporaci√≥n al D.L. N¬∞ 20530.\n‚Ä¢ Resoluci√≥n de cese.\n‚Ä¢ Resoluci√≥n de pensi√≥n definitiva.\n‚Ä¢ 3 √∫ltimas boletas de pago de pensi√≥n del fallecido.\n‚Ä¢ Nro de cuenta del Banco de la Naci√≥n.",
                },
                {
                    text: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Reconocimiento como Herederos de Deuda Social",
                    action: "message",
                    response:
                        "üìú <strong>Requisitos:</strong>\n‚Ä¢ Sucesi√≥n intestada.\n‚Ä¢ Testimonio expedido por la notar√≠a.\n‚Ä¢ Sentencia de vista del proceso judicial.\n‚Ä¢ Resoluci√≥n consentida del proceso judicial.\n‚Ä¢ Liquidaci√≥n del proceso judicial.\n‚Ä¢ DNI de los herederos universales.",
                },
                {
                    text: "<strong>‚ö∞Ô∏è Gastos de Sepelio</strong>\n<small>Subsidios</small>",
                    action: "menu",
                    target: "SEPELIO_LUTO",
                },
                {
                    text: "üîô <strong>Volver al inicio</strong>",
                    action: "menu",
                    target: "main",
                },
            ],
        },
        SEPELIO_LUTO: {
            title: "‚ö∞Ô∏è <strong>Sepelios</strong>\nTipos de gasto:",
            options: [
                {
                    text: "üíê Subsidio por Gastos por Sepelio",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n‚Ä¢ Solicitud dirigida al gerente.\n‚Ä¢ Acta de defunci√≥n.\n‚Ä¢ Acta original de matrimonio o de nacimiento, dependiendo de quien solicita.\n‚Ä¢ DNI del fallecido.\n‚Ä¢ DNI del solicitante.\n‚Ä¢ Comprobantes de pago de los gastos realizados.\n‚Ä¢ Resoluci√≥n de pensi√≥n.\n‚Ä¢ √öltima boleta de pago de pensi√≥n del fallecido\n‚Ä¢ Nro de cuenta del Banco de la Naci√≥n.",
                },
                {
                    text: "üí∏ Subsidio por Fallecimiento",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n‚Ä¢ Solicitud dirigida al gerente.\n‚Ä¢ Acta de defunci√≥n.\n‚Ä¢ Acta original de matrimonio o sucesi√≥n intestada, dependiendo de quien solicita.\n‚Ä¢ DNI del fallecido.\n‚Ä¢ DNI del solicitante.\n‚Ä¢ Resoluci√≥n de pensi√≥n.\n‚Ä¢ √öltima boleta de pago de pensi√≥n del fallecido.\n‚Ä¢ Nro de cuenta del Banco de la Naci√≥n.",
                },
                {
                    text: "‚Ü©Ô∏è <strong>Volver a Tr√°mites</strong>",
                    action: "menu",
                    target: "STRAMITES",
                },
            ],
        },
        PLEGALES: {
            title:
                "‚öñÔ∏è <strong>Procedimientos Legales</strong>\n√Årea jur√≠dica especializada:",
            options: [
                {
                    text: "üë®‚Äç‚öñÔ∏è Sentencias Consentidas",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n‚Ä¢ Copia del D.N.I del beneficiario (legible).\n‚Ä¢ Resoluci√≥n Directoral de Reconocimiento de Deuda..\n‚Ä¢ Auto-admisorio de la Demanda.\n‚Ä¢ Sentencia Judicial de 1ra y 2da Instancia.\n‚Ä¢ Resoluci√≥n Judicial que declara Consentida.\n‚Ä¢ Resoluci√≥n Judicial que aprueba la Liquidaci√≥n de Pool de Peritos.\n‚Ä¢ Liquidaci√≥n de Pool de Peritos.\n‚Ä¢ Resoluci√≥n Judicial de Requerimiento de Pago.\n‚Ä¢ Notificaci√≥n Judicial de Requerimiento de Pago.",
                },
                {
                    text: "üë™ Requisito de Herederos",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n‚Ä¢ Copia del D.N.I de herederos o beneficiarios.\n‚Ä¢ Resoluci√≥n Directoral de Reconocimiento de Herederos.\n‚Ä¢ Resoluci√≥n de Incorporaci√≥n al proceso judicial como heredero en el expediente principal en ejecuci√≥n.\n‚Ä¢ Sucesi√≥n Intestada JUDICIAL O NOTARIAL.\n‚Ä¢ Partida Registral de la Sucesi√≥n Intestada DEFINITIVA debidamente inscrita en la SUNARP.",
                },
                {
                    text: "ü©∫ Requisitos por Enfermedad",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n‚Ä¢ Informe firma por la Junta de M√©dicos <em>(TRES MEDICOS de MINSA O ESSALUD)</em>.\n‚Ä¢ Los m√©dicos que suscriben el informe deben estar habilitados, indicar especialidad y N.¬∞ de colegiatura otorgado por el Colegio de M√©dicos del Per√∫.\n‚Ä¢ Indicar FASE y/o ESTADO de la enfermedad sea terminal o avanzado de paciente.\n‚Ä¢ Especificar EL CODIGO DE LA ENFERMEDAD.\n‚Ä¢ Fecha, lugar, N.¬∞ de Informe, datos completos del paciente y motivo de la expedici√≥n del Informe.",
                },
                {
                    text: "üîô <strong>Volver al inicio</strong>",
                    action: "menu",
                    target: "main",
                },
            ],
        },
        PAREA: {
            title:
                "üåÑ <strong>Tramites de √Årea de Comunidades</strong>\nProcedimientos y Requisitos:",
            options: [
                {
                    text: "<strong>üè° Comunidades Campesinas</strong>\n<small>Reconocimiento y titulaci√≥n</small>",
                    action: "menu",
                    target: "CCAMPESINASS",
                },
                {
                    text: "<strong>üå≥ Comunidades Nativas</strong>\n<small>Reconocimiento y titulaci√≥n</small>",
                    action: "menu",
                    target: "CNATIVAS",
                },
                {
                    text: "<strong>üìù Procedimientos Administrativos</strong>\n<small>Saneamientos y m√°s</small>",
                    action: "menu",
                    target: "PADMINISTRATIVOS",
                },
                {
                    text: "<strong>üó∫Ô∏è Servicios Catastrales</strong>\n<small>Asignacion de codigos y mas</small>",
                    action: "menu",
                    target: "SCATASTRALES",
                },
                {
                    text: "üõ£Ô∏è Formalizaci√≥n Tierras Eriazas",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n Los Requisitos se aprecian en la siguiente imagen.<strong>\nHaz click üëá:</strong>",
                    image: "ERIAZAS.png",
                },
                {
                    text: "üë®‚Äçüíº Cambio de Titular en Zonas Catastradas ",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n‚Ä¢ La informaci√≥n se√±alada en el art√≠culo 124 del TUO de la LPAG.\n‚Ä¢ La ubicaci√≥n del predio y el C√≥digo de Referencia Catastral.\n‚Ä¢ Documento que acredite fehacientemente la condici√≥n de propietario. <small>En caso de sucesivas transferencias, se acredita el tracto sucesivo.</small>\n‚Ä¢ De encontrarse inscrito el predio, copia literal actualizada de la partida registral del predio.",
                },
                {
                    text: "üîô <strong>Volver al inicio</strong>",
                    action: "menu",
                    target: "main",
                },
            ],
        },
        CCAMPESINASS: {
            title:
                "üè° <strong>Comunidades Campesinas</strong>\nProcedimientos disponibles:",
            options: [
                {
                    text: "üÜî Reconocimiento de Comunidades",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n Los Requisitos se aprecian en la siguiente imagen.<strong>\nHaz click üëá:</strong>",
                    image: "RECON_COM_CAMPESINAS.png",
                },
                {
                    text: "üìç Deslinde y Titulaci√≥n de Comunidades",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n Los Requisitos se aprecian en la siguiente imagen.<strong>\nHaz click üëá:</strong>",
                    image: "DESLINDE_TITULACION_COM_CAMPESINAS.png",
                },
                {
                    text: "üõ∞Ô∏è Georreferenciaci√≥n Comunidades",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n Los Requisitos se aprecian en la siguiente imagen.<strong>\nHaz click üëá:</strong>",
                    image: "GEOREF_CAMPESI.png",
                },
                {
                    text: "‚Ü©Ô∏è <strong>Volver a √Årea Comunidades</strong>",
                    action: "menu",
                    target: "PAREA",
                },
            ],
        },
        CNATIVAS: {
            title:
                "üå≥ <strong>Comunidades Nativas</strong>\nProcedimientos disponibles:",
            options: [
                {
                    text: "üÜî Reconocimiento de Comunidades",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n Los Requisitos se aprecian en la siguiente imagen.<strong>\nHaz click üëá:</strong>",
                    image: "RECON_COM_NATIVA.png",
                },
                {
                    text: "üìç Demarcaci√≥n y Titulaci√≥n de Comunidades",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n Los Requisitos se aprecian en la siguiente imagen.<strong>\nHaz click üëá:</strong>",
                    image: "DEMARC_COM_NATIVA.png",
                },
                {
                    text: "üõ∞Ô∏è Georreferenciaci√≥n de Comunidades",
                    action: "message",
                    response:
                        "üßæ <strong>Requisitos:</strong>\n Los Requisitos se aprecian en la siguiente imagen.<strong>\nHaz click üëá:</strong>",
                    image: "GEOREF_NATIVA.png",
                },
                {
                    text: "‚Ü©Ô∏è <strong>Volver a √Årea Comunidades</strong>",
                    action: "menu",
                    target: "PAREA",
                },
            ],
        },
        PADMINISTRATIVOS: {
            title:
                "üìë <strong>Procedimientos Administrativos</strong>\nProcedimientos disponibles:",
            options: [
                {
                    text: "üîÑ Saneamiento de predios r√∫sticos (Zonas catastradas/no catastradas)",
                    action: "message",
                    response:
                        "üìÑ Requisitos completos en imagen.<strong>\nHaz click üëá:</strong>",
                    image: "PAdm_1.png",
                },
                {
                    text: "üèúÔ∏è Formalizaci√≥n de Eriazas (antes de 2010)",
                    action: "message",
                    response:
                        "üìÑ Requisitos completos en imagen.<strong>\nHaz click üëá:</strong>",
                    image: "PAdm_2.png",
                },
                {
                    text: "‚è≥ Declaraci√≥n por Prescripci√≥n (predios particulares)",
                    action: "message",
                    response:
                        "üìÑ Requisitos completos en imagen.<strong>\nHaz click üëá:</strong>",
                    image: "PAdm_3.png",
                },
                {
                    text: "üìù Declaraci√≥n de propiedad y regulaci√≥n de transferencias de dominio",
                    action: "message",
                    response:
                        "üìÑ Requisitos completos en imagen.<strong>\nHaz click üëá:</strong>",
                    image: "PAdm_4.png",
                },
                {
                    text: "‚úîÔ∏è Rectificaci√≥n de √°reas/linderos (predios rurales)",
                    action: "message",
                    response:
                        "üìÑ Requisitos completos en imagen.<strong>\nHaz click üëá:</strong>",
                    image: "PAdm_5.png",
                },
                {
                    text: "‚Ü©Ô∏è <strong>Volver a √Årea Comunidades</strong>",
                    action: "menu",
                    target: "PAREA",
                },
            ],
        },
        SCATASTRALES: {
            title:
                "üó∫Ô∏è <strong>Servicios Catastrales</strong>\nServicios disponibles:",
            options: [
                {
                    text: "üî¢ Asignaci√≥n de C√≥digo catastral y expedici√≥n de certificado para inmatriculaci√≥n de predios (zonas no catastradas)",
                    action: "message",
                    response:
                        "üìÑ Requisitos completos en imagen<strong>\nHaz click üëá:</strong>",
                    image: "SCat_1.png",
                },
                {
                    text: "‚úèÔ∏è Asignaci√≥n de C√≥digo catastral y expedici√≥n de certificado para modificaci√≥n de predios (zonas catastradas) ",
                    action: "message",
                    response:
                        "üìÑ Requisitos completos en imagen<strong>\nHaz click üëá:</strong>",
                    image: "SCat_2.png",
                },
                {
                    text: "üè∑Ô∏è Expedici√≥n de Certificado catastral para inmatriculaci√≥n de predios (zonas catastradas)",
                    action: "message",
                    response:
                        "üìÑ Requisitos completos en imagen<strong>\nHaz click üëá:</strong>",
                    image: "SCat_3.png",
                },
                {
                    text: "üìë Visaci√≥n de planos y de memoria descriptiva de predios (procesos judiciales zonas catastradas/no catastradas)",
                    action: "message",
                    response:
                        "üìÑ Requisitos completos en imagen. <strong>\nHaz click üëá:</strong>",
                    image: "SCat_4.png",
                },
                {
                    text: "‚Ü©Ô∏è <strong>Volver a √Årea Comunidades</strong>",
                    action: "menu",
                    target: "PAREA",
                },
            ],
        },
    };

    function showMenu(menuId) {
        const menu = menuStructure[menuId];
        if (!menu) return;

        const typing = showTypingIndicator();
        setTimeout(() => {
            chatMessages.innerHTML = "";
            addBotMessage(menu.title);

            if (menuId !== "main") {
                const backDiv = document.createElement("div");
                const backBtn = document.createElement("button");
                backBtn.className = "back-btn";
                backBtn.textContent = "Volver";
                backBtn.onclick = function () {
                    if (menuHistory.length > 0) {
                        const previousMenu = menuHistory.pop();
                        showMenu(previousMenu);
                        saveChatbotState();
                    }
                };
                backDiv.appendChild(backBtn);
                chatMessages.appendChild(backDiv);
            }

            const optionsDiv = document.createElement("div");
            optionsDiv.className = "option-buttons";

            menu.options.forEach((option) => {
                const btn = document.createElement("button");
                btn.className = "option-btn";
                if (option.action === "menu") btn.classList.add("has-children");
                btn.innerHTML = option.text;
                btn.onclick = function () {
                    addUserMessage(option.text.replace(/[^a-zA-Z√°-√∫√Å-√ö ]/g, "").trim());

                    if (option.action === "menu") {
                        if (menuId !== "main") menuHistory.push(menuId);
                        setTimeout(() => {
                            showMenu(option.target);
                            saveChatbotState();
                        }, 300);
                    } else if (option.action === "message") {
                        setTimeout(() => {
                            if (option.image) {
                                addBotMessageWithImage(option.response, option.image);
                            } else {
                                addBotMessage(option.response);
                            }
                            setTimeout(() => showContinueOptions(menuId), 500);
                        }, 500);
                    } else if (option.action === "end") {
                        endConversation(option.response);
                    }
                };
                optionsDiv.appendChild(btn);
            });

            chatMessages.appendChild(optionsDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            currentMenu = menuId;
            saveChatbotState();
        }, 800);
    }

    function addBotMessage(text) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message bot-message";
        messageDiv.innerHTML = text.replace(/\n/g, "<br>");
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addUserMessage(text) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message user-message";
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }



    function addBotMessageWithImage(text, imageName) {
    const messageDiv = document.createElement("div");
    messageDiv.className = "message bot-message";
    messageDiv.innerHTML = text.replace(/\n/g, "<br>");

    const imgContainer = document.createElement("div");
    imgContainer.className = "response-image-container";

    const img = document.createElement("img");
    const imgSrc = "/landing_page/img/" + imageName;
    img.src = imgSrc;
    img.className = "response-image";
    img.alt = "Imagen informativa";
    img.loading = "lazy";

    // Modal al hacer clic
    img.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
        openHdLink.href = this.src;
    };

    // Bot√≥n de descarga (con √≠cono SVG)
    const downloadLink = document.createElement("a");
    downloadLink.href = imgSrc;
    downloadLink.download = imageName;
    downloadLink.className = "download-image-link";
    downloadLink.innerHTML = `
        <i class="fas fa-download"></i> Descargar imagen
    `;

    imgContainer.appendChild(img);
    imgContainer.appendChild(downloadLink);
    messageDiv.appendChild(imgContainer);
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}


    function endConversation(message) {
        chatMessages.innerHTML = "";
        addBotMessage(message);
        setTimeout(() => {
            const restartBtn = document.createElement("button");
            restartBtn.className = "restart-chat-btn";
            restartBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Reiniciar chat';
            restartBtn.onclick = function () {
                menuHistory = [];
                showMenu("main");
                saveChatbotState();
            };
            chatMessages.appendChild(restartBtn);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 2000);
    }

    function showContinueOptions(returnMenu) {
        const optionsDiv = document.createElement("div");
        optionsDiv.className = "option-buttons";

        const continueBtn = document.createElement("button");
        continueBtn.className = "option-btn";
        continueBtn.innerHTML = '<i class="fas fa-reply"></i> Continuar consulta';
        continueBtn.onclick = function () {
            showMenu(returnMenu);
        };
        optionsDiv.appendChild(continueBtn);

        const endBtn = document.createElement("button");
        endBtn.className = "end-chat-btn";
        endBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Terminar chat';
        endBtn.onclick = function () {
            endConversation("¬°Gracias por contactar a GERAGRI! üå±\nEstamos para servirte cuando lo necesites.");
        };
        optionsDiv.appendChild(endBtn);

        chatMessages.appendChild(optionsDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage() {
        const message = userInput.value.trim();
        if (message !== "") {
            addUserMessage(message);
            userInput.value = "";

            const typing = showTypingIndicator();
            setTimeout(() => {
                chatMessages.removeChild(typing);
                addBotMessage("Recib√≠ tu mensaje. ¬øQu√© m√°s necesitas?");

                const optionsDiv = document.createElement("div");
                optionsDiv.className = "option-buttons";

                const mainMenuBtn = document.createElement("button");
                mainMenuBtn.className = "option-btn";
                mainMenuBtn.innerHTML = '<i class="fas fa-home"></i> Men√∫ principal';
                mainMenuBtn.onclick = function () {
                    menuHistory = [];
                    showMenu("main");
                    saveChatbotState();
                };
                optionsDiv.appendChild(mainMenuBtn);

                const endBtn = document.createElement("button");
                endBtn.className = "end-chat-btn";
                endBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Terminar chat';
                endBtn.onclick = function () {
                    endConversation("¬°Gracias por tu consulta! Si necesitas m√°s ayuda, reinicia el chat cuando quieras.");
                };
                optionsDiv.appendChild(endBtn);

                chatMessages.appendChild(optionsDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1500);
        }
    }

    // ========================
    // 5. EVENT LISTENERS
    // ========================
    videoAvatar.addEventListener("loadeddata", function () {
        videoAvatar.play().catch(e => console.log("Autoplay no permitido:", e));
    });

    minimizeBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        isMinimized = !isMinimized;
        if (isMinimized) {
            chatbot.classList.add("minimized");
            minimizeBtn.innerHTML = '<i class="fas fa-plus"></i>';
        } else {
            chatbot.classList.remove("minimized");
            minimizeBtn.innerHTML = '<i class="fas fa-minus"></i>';
        }
        saveChatbotState();
    });

    closeBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        isClosed = true;
        chatbot.classList.remove("visible");
        setTimeout(() => {
            chatbot.classList.add("closed");
            launcher.style.display = "flex";
            saveChatbotState();
        }, 300);
    });

    launcher.addEventListener("click", function () {
        isClosed = false;
        chatbot.classList.remove("closed");
        setTimeout(() => {
            chatbot.classList.add("visible");
            launcher.style.display = "none";
            saveChatbotState();
        }, 50);
    });

    chatbotHeader.addEventListener("click", function () {
        if (isMinimized) {
            isMinimized = false;
            chatbot.classList.remove("minimized");
            minimizeBtn.innerHTML = '<i class="fas fa-minus"></i>';
            saveChatbotState();
        }
    });

    sendBtn.addEventListener("click", sendMessage);

    userInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            sendMessage();
        }
    });

    document.addEventListener("click", function (e) {
        if (e.target.classList.contains("response-image")) {
            modal.style.display = "block";
            modalImg.src = e.target.src;
            openHdLink.href = e.target.src;
        }
    });

    closeModal.addEventListener("click", function () {
        modal.style.display = "none";
    });

    modal.addEventListener("click", function (e) {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });

    chatbot.addEventListener("click", function () {
        userInput.focus();
    });

    // ========================
    // 6. INICIALIZACI√ìN
    // ========================
    loadChatbotState(); // Cargar estado al inicio
    showMenu(currentMenu); // Mostrar men√∫ inicial

    // Animaci√≥n de aparici√≥n (si no est√° cerrado)
    setTimeout(() => {
        if (!isClosed) {
            chatbot.classList.add("visible");
        }
    }, 10);
});